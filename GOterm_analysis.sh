#####====================================================================================================================================
#####====================================================================================================================================
####====================================================================================================================================
#####====================================================================================================================================
#####====================================================================================================================================
#####========================================== Assign GO-terms to each HOG ============================================================
#####====================================================================================================================================
#####====================================================================================================================================
####====================================================================================================================================
#####====================================================================================================================================
#####====================================================================================================================================

conda activate miniprot 

#First extract the longest sequence per HOG
split -700 list_orthogroups.txt split_list_orthogroup_
for curr_file in split_list_orthogroup_* ; do sbatch --qos=6hours -c 2 --mem=4G extract_longest_seq.sh $curr_file ; done
cat longest_seq_per_HOG*.csv > Concat_longest_seq_per_HOG.csv
rm longest_seq_per_HOG.split_list_orthogroup_* ; rm split_list_orthogroup_* ; rm curr_HOG_list.*


#Extract corresponding sequences
cut -f2 -d "," Concat_longest_seq_per_HOG.csv > list_long_seq.txt
xargs samtools faidx concatenated_proteomes.fa < list_long_seq.txt > Concat_longest_seq_per_HOG.fa


#Rename sequences
cut -f1 -d "," Concat_longest_seq_per_HOG.csv > list_HOG.txt
paste -d "\t" list_long_seq.txt list_HOG.txt > renaming_file 
perl rename_fasta.pl renaming_file Concat_longest_seq_per_HOG.fa > Concat_longest_seq_per_HOG.named.fa 


#Download uniprot databases

wget https://ftp.uniprot.org/pub/databases/uniprot/knowledgebase/complete/uniprot_sprot.fasta.gz

gzip -d uniprot_sprot.fasta.gz

module load DIAMOND
diamond makedb --in uniprot_sprot.fasta -d uniprot_sprot --threads 8


diamond blastp -p 20 --query Concat_Dr_or_longest_seq_per_HOG.named.fa --max-target-seqs 1 --out HOG_vs_Uniprot.diamond.tsv --db uniprot_sprot --outfmt 6





#####====================================================================================================================================
#####====================================================================================================================================
####====================================================================================================================================
#####====================================================================================================================================
#####====================================================================================================================================
#####========================================== Accessory scripts ======================================================================
#####====================================================================================================================================
#####====================================================================================================================================
####====================================================================================================================================
#####====================================================================================================================================
#####====================================================================================================================================



=========================================================================================
==========================================================================================
======================= extract_longest_seq.sh ===========================================
==========================================================================================
==========================================================================================

#!/bin/bash


#SBATCH --job-name=extract_seq   # Job name

LMOD_DISABLE_SAME_NAME_AUTOSWAP=no


curr_file=$1 


IFS=$'\n'


ortho_file=N5.tsv 
rm longest_seq_per_HOG.$curr_file.csv
for curr_HOG in `cat $curr_file` ; do 
	grep "$curr_HOG	" $ortho_file | sed 's/, /,/g' | cut -f4- | tr ',' '\n' | tr '\t' '\n' | grep -v "$curr_HOG" | sed '/^$/d' | sed 's/_1$//g'  > curr_HOG_list.$curr_file
	longest_seq=`grep -F -f curr_HOG_list.$curr_file concatenated_proteomes.fa.fai | sort -k2 -n | tail -1 | cut -f1`
	echo "$curr_HOG,$longest_seq" >> longest_seq_per_HOG.$curr_file.csv
done


==========================================================================================
==========================================================================================
==========================================================================================
==========================================================================================






